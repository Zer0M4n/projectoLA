<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8" />
  <title>Mini IDE Pyra - Monaco Edition</title>
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", Arial, sans-serif;
      background-color: #1e1e1e;
      color: #d4d4d4;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }

    header {
      background: #252526;
      color: #50fa7b;
      padding: 10px 20px;
      font-size: 1.4em;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    #container {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    #editor {
      flex: 2;
      height: 100%;
      border-right: 1px solid #333;
    }

    #right-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      background: #1e1e1e;
    }

    button {
      background: #50fa7b;
      border: none;
      color: #1e1e1e;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
      border-radius: 6px;
      font-weight: bold;
    }

    button:hover {
      background: #69ff94;
    }

    button:disabled {
      background: #444;
      cursor: not-allowed;
      opacity: 0.6;
    }

    pre {
      background: #000000;
      color: #f8f8f2;
      padding: 10px;
      flex: 1;
      margin: 5px;
      overflow-y: auto;
      border-radius: 6px;
      font-size: 14px;
      white-space: pre-wrap;
      word-break: break-word;
    }

    #history {
      background: #111;
      padding: 10px;
      margin: 5px;
      flex: 1;
      overflow-y: auto;
      border-radius: 6px;
      font-size: 13px;
      color: #ccc;
    }

    .history-entry {
      padding: 8px;
      margin-bottom: 8px;
      background: #1a1a1a;
      border-left: 3px solid #50fa7b;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .history-entry:hover {
      background: #252526;
    }

    .history-timestamp {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }

    .history-code {
      font-family: monospace;
      white-space: pre-wrap;
      word-break: break-all;
      color: #d4d4d4;
    }

    #modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #modal-content {
      background: #252526;
      padding: 30px;
      border-radius: 10px;
      max-width: 700px;
      max-height: 80vh;
      overflow-y: auto;
      color: #d4d4d4;
    }

    #modal-content h2 {
      color: #50fa7b;
      margin-top: 0;
    }

    #modal-content code {
      background: #1e1e1e;
      padding: 2px 6px;
      border-radius: 3px;
      color: #ff79c6;
    }

    #modal-content pre {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 6px;
      overflow-x: auto;
    }

    .close-modal {
      float: right;
      font-size: 28px;
      cursor: pointer;
      color: #888;
    }

    .close-modal:hover {
      color: #fff;
    }

    .error-marker {
      color: #ff5555;
    }

    .warning-marker {
      color: #ffb86c;
    }
  </style>
</head>

<body>
  <header>
    <div>üêç Mini IDE Pyra - Monaco Edition</div>
  </header>

  <div id="container">
    <div id="editor"></div>

    <div id="right-panel">
      <div>
        <button id="runBtn">‚ñ∂ Ejecutar</button>
        <button id="clearBtn">üßπ Limpiar salida</button>
        <button id="clearHistoryBtn">üóëÔ∏è Limpiar historial</button>
        <button id="manualBtn">üìñ Manual</button>
      </div>
      <h3 style="margin-left:10px;">Salida:</h3>
      <pre id="output">Listo para ejecutar tu c√≥digo...</pre>
      <h3 style="margin-left:10px;">Historial:</h3>
      <div id="history"></div>
    </div>
  </div>

  <!-- Modal para el manual -->
  <div id="modal">
    <div id="modal-content">
      <span class="close-modal">&times;</span>
      <h2>üìñ Manual de Pyra</h2>
      
      <h3>Variables</h3>
      <pre>var nombre = valor
var x = 10
var texto = "Hola"

# Reasignaci√≥n (sin var)
x = 20
texto = "Mundo"</pre>

      <h3>Funciones</h3>
      <pre>func suma(a, b):
    return a + b

var resultado = suma(5, 3)
print(resultado)</pre>

      <h3>Condicionales</h3>
      <pre>if x > 10:
    print("Mayor")
elif x == 10:
    print("Igual")
else:
    print("Menor")</pre>

      <h3>Bucles While</h3>
      <pre>var i = 0
while i < 5:
    print(i)
    i = i + 1</pre>

      <h3>Bucles For</h3>
      <pre>for i in range(5):
    print(i)

for letra in "Hola":
    print(letra)</pre>

      <h3>Control de flujo</h3>
      <pre>for i in range(10):
    if i == 5:
        break
    if i == 3:
        continue
    print(i)</pre>

      
      <h3>Reglas de sintaxis</h3>
      <ul>
        <li>Indentaci√≥n: 4 espacios (no tabs)</li>
        <li>Bloques terminan con <code>:</code></li>
        <li>Declaraci√≥n de variables: <code>var nombre = valor</code></li>
        <li>Reasignaci√≥n de variables: <code>nombre = nuevo_valor</code> (sin var)</li>
        <li>Comentarios con <code>#</code></li>
      </ul>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>

  <script>
    require.config({ paths: { 'vs': 'https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs' } });
    require(["vs/editor/editor.main"], function () {
      const editor = monaco.editor.create(document.getElementById("editor"), {
        value: `func factorial(n):
    if n <= 1:
        return 1
    else:
        return n * factorial(n - 1)

var resultado = factorial(5)
print(resultado)`,
        language: "python",
        theme: "vs-dark",
        automaticLayout: true,
        fontSize: 14,
        minimap: { enabled: false },
        cursorBlinking: "blink",
        cursorSmoothCaretAnimation: true,
        roundedSelection: true,
        scrollBeyondLastLine: false
      });

      const runBtn = document.getElementById("runBtn");
      const clearBtn = document.getElementById("clearBtn");
      const clearHistoryBtn = document.getElementById("clearHistoryBtn");
      const manualBtn = document.getElementById("manualBtn");
      const output = document.getElementById("output");
      const historyDiv = document.getElementById("history");
      const modal = document.getElementById("modal");
      const closeModal = document.querySelector(".close-modal");

      // --- LINT usando checker.py del servidor ---
      async function lintCode() {
        const code = editor.getValue();
        try {
          const res = await fetch("/lint", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code })
          });
          
          if (!res.ok) {
            console.error("Error en /lint:", res.status);
            return;
          }

          const data = await res.json();

          // Crear marcadores visuales de Monaco
          const markers = data.errors.map(err => ({
            startLineNumber: err.line || 1,
            endLineNumber: err.line || 1,
            startColumn: err.column || 1,
            endColumn: 999,
            message: err.message,
            severity: err.severity === 'warning' 
              ? monaco.MarkerSeverity.Warning 
              : monaco.MarkerSeverity.Error
          }));

          monaco.editor.setModelMarkers(editor.getModel(), "lint", markers);
        } catch (e) {
          console.error("Error al hacer lint:", e);
        }
      }

      // Lint autom√°tico con debounce
      let lintTimeout;
      editor.onDidChangeModelContent(() => {
        clearTimeout(lintTimeout);
        lintTimeout = setTimeout(lintCode, 800);
      });

      // Lint inicial
      lintCode();

      // --- EJECUTAR usando interpreter.py del servidor ---
      runBtn.addEventListener("click", async () => {
        const code = editor.getValue();
        output.textContent = "‚è≥ Ejecutando...\n";
        runBtn.disabled = true;

        try {
          const res = await fetch("/run", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ code })
          });

          const data = await res.json();
          
          // Mostrar la salida (con error o sin error)
          if (data.output) {
            output.textContent = data.output;
          } else {
            output.textContent = "Sin salida.";
          }

          // Agregar al historial solo si hubo contenido
          if (code.trim()) {
            addToHistory(code, data.output || "Sin salida");
          }
        } catch (err) {
          output.textContent = "‚ùå Error al conectar con el servidor:\n" + err.message + "\n\n¬øEl servidor est√° corriendo en http://localhost:5000?";
          console.error("Error completo:", err);
        } finally {
          runBtn.disabled = false;
        }
      });

      // --- AGREGAR AL HISTORIAL ---
      function addToHistory(code, result) {
        const entry = document.createElement("div");
        entry.className = "history-entry";
        
        const timestamp = document.createElement("div");
        timestamp.className = "history-timestamp";
        timestamp.textContent = new Date().toLocaleTimeString();
        
        const codeDiv = document.createElement("div");
        codeDiv.className = "history-code";
        const preview = code.length > 100 ? code.slice(0, 100) + '...' : code;
        codeDiv.textContent = preview;
        
        entry.appendChild(timestamp);
        entry.appendChild(codeDiv);
        
        // Click para restaurar c√≥digo
        entry.addEventListener("click", () => {
          editor.setValue(code);
          editor.focus();
        });
        
        historyDiv.insertBefore(entry, historyDiv.firstChild);

        // Limitar historial a 20 entradas
        while (historyDiv.children.length > 20) {
          historyDiv.removeChild(historyDiv.lastChild);
        }
      }

      // --- LIMPIAR SALIDA ---
      clearBtn.addEventListener("click", () => {
        output.textContent = "Listo para ejecutar tu c√≥digo...";
        monaco.editor.setModelMarkers(editor.getModel(), "lint", []);
      });

      // --- LIMPIAR HISTORIAL ---
      clearHistoryBtn.addEventListener("click", () => {
        historyDiv.innerHTML = "";
      });

      // --- MODAL DE MANUAL ---
      manualBtn.addEventListener("click", () => {
        modal.style.display = "flex";
      });

      closeModal.addEventListener("click", () => {
        modal.style.display = "none";
      });

      modal.addEventListener("click", (e) => {
        if (e.target === modal) {
          modal.style.display = "none";
        }
      });

      // Atajo de teclado: Ctrl+Enter para ejecutar
      editor.addCommand(monaco.KeyMod.CtrlCmd | monaco.KeyCode.Enter, () => {
        runBtn.click();
      });

      // Atajo de teclado: ESC para cerrar modal
      document.addEventListener("keydown", (e) => {
        if (e.key === "Escape" && modal.style.display === "flex") {
          modal.style.display = "none";
        }
      });
    });
  </script>
</body>
</html>